<html>

<head>
	<script src="../node_modules/codemirror/lib/codemirror.js"></script>
	<link rel="stylesheet" href="../node_modules/codemirror/lib/codemirror.css">
	<script src="../node_modules/codemirror/mode/css/css.js"></script>
	<script src="../node_modules/codemirror/mode/python/python.js"></script>
	<script src="../node_modules/codemirror/addon/hint/show-hint.js"></script>
	<script src="../node_modules/codemirror/addon/hint/css-hint.js"></script>
	<script src="../node_modules/blockly/blockly_compressed.js"></script>
	<script src="../node_modules/blockly/python_compressed.js"></script>
	<script src="../node_modules/blockly/blocks_compressed.js"></script>
	<script src="../node_modules/blockly/msg/js/en.js"></script>
	<link rel="stylesheet" href="../node_modules/codemirror/addon/hint/show-hint.css">
	<link rel="stylesheet" href="../node_modules/codemirror/theme/ambiance.css">

	<script src="build/python_bundle.js"></script>

	<style>
		body {
			background-color: #eee;
		}

		.CodeMirror {
			height: auto;
		}
	</style>
</head>

<table style="height: 100%; width: 100%">
	<tbody>
		<tr>
			<td id="blocklyArea" style="height: 99%; background: #fc9; text-align: center"></td>
			<td id="editorArea" style="height: 99%; background: #fc9; text-align: center"></td>
		</tr>
	</tbody>
</table>

<div id="blocklyDiv" style="position: absolute"></div>
<div id="editorDiv" style="position: absolute"></div>

<xml id="toolbox" style="display: none">
	<category name="Logic" colour="%{BKY_LOGIC_HUE}">
		<block type="controls_if"></block>
		<block type="logic_compare"></block>
		<block type="logic_operation"></block>
		<block type="logic_negate"></block>
		<block type="logic_boolean"></block>
		<block type="logic_null"></block>
		<block type="logic_ternary"></block>
	</category>
	<category name="Loops" colour="%{BKY_LOOPS_HUE}">
		<block type="controls_repeat_ext">
			<value name="TIMES">
				<shadow type="math_number">
					<field name="NUM">10</field>
				</shadow>
			</value>
		</block>
		<block type="controls_whileUntil"></block>
		<block type="controls_for">
			<value name="FROM">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
			<value name="TO">
				<shadow type="math_number">
					<field name="NUM">10</field>
				</shadow>
			</value>
			<value name="BY">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
		</block>
		<block type="controls_forEach"></block>
		<block type="controls_flow_statements"></block>
	</category>
	<category name="Math" colour="%{BKY_MATH_HUE}">
		<block type="math_number">
			<field name="NUM">123</field>
		</block>
		<block type="math_arithmetic">
			<value name="A">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
			<value name="B">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
		</block>
		<block type="math_single">
			<value name="NUM">
				<shadow type="math_number">
					<field name="NUM">9</field>
				</shadow>
			</value>
		</block>
		<block type="math_trig">
			<value name="NUM">
				<shadow type="math_number">
					<field name="NUM">45</field>
				</shadow>
			</value>
		</block>
		<block type="math_constant"></block>
		<block type="math_number_property">
			<value name="NUMBER_TO_CHECK">
				<shadow type="math_number">
					<field name="NUM">0</field>
				</shadow>
			</value>
		</block>
		<block type="math_round">
			<value name="NUM">
				<shadow type="math_number">
					<field name="NUM">3.1</field>
				</shadow>
			</value>
		</block>
		<block type="math_on_list"></block>
		<block type="math_modulo">
			<value name="DIVIDEND">
				<shadow type="math_number">
					<field name="NUM">64</field>
				</shadow>
			</value>
			<value name="DIVISOR">
				<shadow type="math_number">
					<field name="NUM">10</field>
				</shadow>
			</value>
		</block>
		<block type="math_constrain">
			<value name="VALUE">
				<shadow type="math_number">
					<field name="NUM">50</field>
				</shadow>
			</value>
			<value name="LOW">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
			<value name="HIGH">
				<shadow type="math_number">
					<field name="NUM">100</field>
				</shadow>
			</value>
		</block>
		<block type="math_random_int">
			<value name="FROM">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
			<value name="TO">
				<shadow type="math_number">
					<field name="NUM">100</field>
				</shadow>
			</value>
		</block>
		<block type="math_random_float"></block>
		<block type="math_atan2">
			<value name="X">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
			<value name="Y">
				<shadow type="math_number">
					<field name="NUM">1</field>
				</shadow>
			</value>
		</block>
	</category>
	<category name="Text" colour="%{BKY_TEXTS_HUE}">
		<block type="text"></block>
		<block type="text_join"></block>
		<block type="text_append">
			<value name="TEXT">
				<shadow type="text"></shadow>
			</value>
		</block>
		<block type="text_length">
			<value name="VALUE">
				<shadow type="text">
					<field name="TEXT">abc</field>
				</shadow>
			</value>
		</block>
		<block type="text_isEmpty">
			<value name="VALUE">
				<shadow type="text">
					<field name="TEXT"></field>
				</shadow>
			</value>
		</block>
		<block type="text_indexOf">
			<value name="VALUE">
				<block type="variables_get">
					<field name="VAR">{textVariable}</field>
				</block>
			</value>
			<value name="FIND">
				<shadow type="text">
					<field name="TEXT">abc</field>
				</shadow>
			</value>
		</block>
		<block type="text_charAt">
			<value name="VALUE">
				<block type="variables_get">
					<field name="VAR">{textVariable}</field>
				</block>
			</value>
		</block>
		<block type="text_getSubstring">
			<value name="STRING">
				<block type="variables_get">
					<field name="VAR">{textVariable}</field>
				</block>
			</value>
		</block>
		<block type="text_changeCase">
			<value name="TEXT">
				<shadow type="text">
					<field name="TEXT">abc</field>
				</shadow>
			</value>
		</block>
		<block type="text_trim">
			<value name="TEXT">
				<shadow type="text">
					<field name="TEXT">abc</field>
				</shadow>
			</value>
		</block>
		<block type="text_print">
			<value name="TEXT">
				<shadow type="text">
					<field name="TEXT">abc</field>
				</shadow>
			</value>
		</block>
		<block type="text_prompt_ext">
			<value name="TEXT">
				<shadow type="text">
					<field name="TEXT">abc</field>
				</shadow>
			</value>
		</block>
	</category>
	<category name="Lists" colour="%{BKY_LISTS_HUE}">
		<block type="lists_create_with">
			<mutation items="0"></mutation>
		</block>
		<block type="lists_create_with"></block>
		<block type="lists_repeat">
			<value name="NUM">
				<shadow type="math_number">
					<field name="NUM">5</field>
				</shadow>
			</value>
		</block>
		<block type="lists_length"></block>
		<block type="lists_isEmpty"></block>
		<block type="lists_indexOf">
			<value name="VALUE">
				<block type="variables_get">
					<field name="VAR">{listVariable}</field>
				</block>
			</value>
		</block>
		<block type="lists_getIndex">
			<value name="VALUE">
				<block type="variables_get">
					<field name="VAR">{listVariable}</field>
				</block>
			</value>
		</block>
		<block type="lists_setIndex">
			<value name="LIST">
				<block type="variables_get">
					<field name="VAR">{listVariable}</field>
				</block>
			</value>
		</block>
		<block type="lists_getSublist">
			<value name="LIST">
				<block type="variables_get">
					<field name="VAR">{listVariable}</field>
				</block>
			</value>
		</block>
		<block type="lists_split">
			<value name="DELIM">
				<shadow type="text">
					<field name="TEXT">,</field>
				</shadow>
			</value>
		</block>
		<block type="lists_sort"></block>
	</category>
	<category name="Colour" colour="%{BKY_COLOUR_HUE}">
		<block type="colour_picker"></block>
		<block type="colour_random"></block>
		<block type="colour_rgb">
			<value name="RED">
				<shadow type="math_number">
					<field name="NUM">100</field>
				</shadow>
			</value>
			<value name="GREEN">
				<shadow type="math_number">
					<field name="NUM">50</field>
				</shadow>
			</value>
			<value name="BLUE">
				<shadow type="math_number">
					<field name="NUM">0</field>
				</shadow>
			</value>
		</block>
		<block type="colour_blend">
			<value name="COLOUR1">
				<shadow type="colour_picker">
					<field name="COLOUR">#ff0000</field>
				</shadow>
			</value>
			<value name="COLOUR2">
				<shadow type="colour_picker">
					<field name="COLOUR">#3333ff</field>
				</shadow>
			</value>
			<value name="RATIO">
				<shadow type="math_number">
					<field name="NUM">0.5</field>
				</shadow>
			</value>
		</block>
	</category>
	<sep></sep>
	<category name="Variables" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
	<category name="Functions" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE"></category>
</xml>


<script>

	var blocklyArea = document.getElementById('blocklyArea');
	var blocklyDiv = document.getElementById('blocklyDiv');
	var dragLoc = 1;
	var updating = 2;

	// References the Blockly workspace area
	var workspace = Blockly.inject(blocklyDiv,
		{ toolbox: document.getElementById('toolbox') });

	// Resizes the Blockly area if the window changes size
	var onresize = function (e) {

		// Compute the absolute coordinates and dimensions of blocklyArea.
		var element = blocklyArea;
		var x = 0;
		var y = 0;
		do {
			x += element.offsetLeft;
			y += element.offsetTop;
			element = element.offsetParent;
		} while (element);

		// Position blocklyDiv over blocklyArea.
		blocklyDiv.style.left = x + 'px';
		blocklyDiv.style.top = y + 'px';
		blocklyDiv.style.width = (blocklyArea.offsetWidth + 3) * dragLoc + 'px';
		blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
		Blockly.svgResize(workspace);
	};
	window.addEventListener('resize', onresize, false);
	onresize();
	Blockly.svgResize(workspace);

	// Resizes the CodeMirror area if the window changes size
	var editorArea = document.getElementById('editorArea');
	var editorDiv = document.getElementById('editorDiv');
	var dividerX;

	var editonresize = function (e) {
		// Compute the absolute coordinates and dimensions of blocklyArea.
		var editelement = editorArea;
		var editx = 0;
		var edity = 0;
		var xshift = editelement.offsetLeft * dragLoc;
		editx += xshift;
		edity += editelement.offsetTop;
		editelement = editelement.offsetParent;
		do {
			editx += editelement.offsetLeft;
			edity += editelement.offsetTop;
			editelement = editelement.offsetParent;
		} while (editelement);
		// Position editorDiv over editorArea.
		dividerX = editx;
		editorDiv.style.left = editx + 'px';
		editorDiv.style.top = edity + 'px';
		editorDiv.style.width = window.innerWidth - xshift + 'px';
		editorDiv.style.height = editorArea.offsetHeight + 'px';
	};
	window.addEventListener('resize', editonresize, false);
	editonresize();

	// The function converts the workspace blocks into Python code, store in variable 'code'
	var code = Blockly.Python.workspaceToCode(workspace);

	// Displays the Python code in the CodeMirror text editor
	var editor = CodeMirror(document.getElementById("editorDiv"), {
		value: code,
		mode: "python",
		tabSize: 5,
		lineNumbers: true,
		firstLineNumber: 1,
		viewportMargin: Infinity,
		extraKeys: { "Ctrl-Space": "autocomplete" }
	});

	// Function for resizing Blockly and CodeMirror areas with the draggable bar down the center
	var isClicked;
	editorDiv.onmousedown = function (e) {
		if (e.clientX - dividerX < 30) {
			isClicked = true;
		}
	}
	onmouseup = function (e) {
		isClicked = false;
	}
	onmousemove = function (e) {
		var margin_error = 2.03;
		if (isClicked) {
			dragLoc = (e.clientX - 30) / window.innerWidth * margin_error;
			onresize();
			editonresize();
		}
	}
	window.addEventListener('moveDivider', onmousemove, false);

	editor.on('change', function (editor) {
		if (updating == 0) {
			updating = 1;
			// Adds a new block to the workspace.
			// "controls_if" can be replaced by any other block name found in \node_modules\blockly\blocks
			var bl = workspace.newBlock("controls_if");
			
			//Display new block visually on the Blocky area
			bl.initSvg();
			bl.render();
		}
		else {
			updating = 0;
		}
	});


	//Update function to output the parse tree after the blockly workspace has changed
	function myUpdateFunction(event) {
		if (updating == 0) {
			updating = 1;
			code = Blockly.Python.workspaceToCode(workspace);

			/* Antlr, invoking the parser
			* InputStream - Vacuum all input from a Reader/InputStream and then treat it like a char[] buffer. Can also pass in a String or char[] to use.
			* Lexer — Recognizer that draws input symbols from a character stream, and performs lexical analysis.
			* Token — Sequence of characters in the source program that matches the pattern for a token and is identified by the lexical analyser as an instance of that token.
			* Parser — An element of a compiler that takes input data and builds a parse tree.
			* Parse tree — an tree that produced by parser, which is ordered and rooted . It reflects the syntax of the input and contains all relationships between elements.
			*/
			editor.getDoc().setValue(code);
			const chars = new window.antlr4.InputStream(editor.getValue());
			const lexer = new window.Python3Lexer.Python3Lexer(chars);
			lexer.strictMode = false;  // do not use strictMode
			const tokens = new window.antlr4.CommonTokenStream(lexer);
			const parser = new window.Python3Parser.Python3Parser(tokens);

			try {
				tree = parser.file_input();
				console.log("THIS IS THE TREE: ", tree.toStringTree(this, parser));
			} catch (error) {
				console.log(error);
			}
			console.log(editor.getValue());
		}
		else if (updating == 2) {
			updating = 0;
		}
		else {
			updating = 0;
		}
	}
	workspace.addChangeListener(myUpdateFunction);


</script>

</html>